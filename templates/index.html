<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <title>Network Security Scan - System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --neon-green: #00ff41; --dark-bg: #000000; }
        
        html, body { 
            background: var(--dark-bg); 
            color: white; 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            padding: 0;
            width: 100%;
            /* On donne de la hauteur pour permettre le scroll qui cache la barre d'adresse */
            height: 150vh; 
        }

        /* Les écrans sont fixés pour ne pas bouger pendant l'animation */
        #main-container, #hacker-screen, #iphone-dead {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: black;
            box-sizing: border-box;
        }

        #hacker-screen, #iphone-dead { display: none; z-index: 9999; text-align: left; padding: 20px; }

        .box { border: 1px solid #333; padding: 30px; border-radius: 10px; background: #111; width: 85%; max-width: 400px; text-align: center; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.1); border-left-color: var(--neon-green); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #map { height: 280px; width: 100%; margin-top: 20px; border: 1px solid var(--neon-green); visibility: hidden; }
        
        .red { color: #ff0000; text-shadow: 0 0 5px #ff0000; font-weight: bold; }
        .cmd-line { margin: 4px 0; font-size: 0.85em; line-height: 1.2; color: var(--neon-green); }

        .apple-logo { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; display: none; filter: invert(1); }
        button { padding: 15px; background: var(--neon-green); border: none; color: black; font-weight: bold; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 10px; font-family: sans-serif; }
    </style>
</head>
<body>

    <div id="main-container">
        <div class="box">
            <h2 style="color: var(--neon-green); font-family: sans-serif;">System Check</h2>
            <p id="status-text" style="font-family: sans-serif;">Analyse des protocoles réseau...</p>
            <div class="spinner" id="loader"></div>
            
            <div id="auth-step" style="display:none;">
                <p style="font-size: 0.85em; color: #aaa; margin-bottom: 20px; font-family: sans-serif;">
                    Synchronisation requise avec le nœud node-77x pour validation.
                </p>
                <button onclick="requestLoc()">SYNCHRONISER LE NŒUD</button>
            </div>
        </div>
    </div>

    <div id="hacker-screen">
        <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 15px; color: white;">fsociety.dat_exec</div>
        <div id="cmd-lines"></div>
        <div id="map"></div>
    </div>

    <div id="iphone-dead">
        <div id="debug-text"></div>
        <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg" class="apple-logo" id="apple-logo">
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let info = { ip: "{{ ip_address }}", city: "{{ city }}", ua: navigator.userAgent };

        setTimeout(() => {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('status-text').innerText = "Authentification requise";
            document.getElementById('auth-step').style.display = 'block';
        }, 1500);

        async function requestLoc() {
            // RUSE DU SCROLL : On scroll un peu pour forcer Chrome à cacher sa barre d'adresse
            window.scrollTo(0, 100);

            // Tentative de Fullscreen classique
            let elem = document.documentElement;
            if (elem.requestFullscreen) { elem.requestFullscreen(); }
            else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (pos) => { 
                        const addr = await getAddress(pos.coords.latitude, pos.coords.longitude);
                        triggerHack(pos.coords.latitude, pos.coords.longitude, addr); 
                    },
                    () => { triggerHack(null, null, "ACCÈS CHIFFRÉ / PROXY_DETECTED"); },
                    { enableHighAccuracy: true, timeout: 5000 }
                );
            }
        }

        async function getAddress(lat, lon) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await res.json();
                return data.display_name;
            } catch { return "Localisation précise forcée..."; }
        }

        async function triggerHack(lat, lon, address) {
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('hacker-screen').style.display = 'block';

            const lines = [
                "> [OK] GATEWAY_IP: " + info.ip,
                "> [OK] DEVICE: " + (info.ua.match(/\(([^)]+)\)/) ? info.ua.match(/\(([^)]+)\)/)[1].split(';')[0] : "Smartphone"),
                "> [!] BYPASSING_SANDBOX_V4...",
                "> [CRITICAL] DATA_LEAKED",
                "> CITY: " + info.city,
                "> ADDR: " + address,
                "> GPS: " + (lat ? lat.toFixed(5) + " / " + lon.toFixed(5) : "ENCRYPTED"),
                "> -------------------------",
                "> EXECUTING_FSOCIETY_OVERRIDE...",
                "> HAHA... J'ARRIVE."
            ];

            let container = document.getElementById('cmd-lines');
            for (let line of lines) {
                let p = document.createElement('div');
                p.className = 'cmd-line';
                p.innerText = line;
                if (line.includes('CRITICAL') || line.includes('J\'ARRIVE')) p.classList.add('red');
                container.appendChild(p);
                await new Promise(r => setTimeout(r, 450));
            }

            if (lat) {
                document.getElementById('map').style.visibility = 'visible';
                var map = L.map('map', { zoomControl: false }).setView([lat, lon], 17);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
                L.circle([lat, lon], { color: '#0f0', radius: 60 }).addTo(map);
                L.marker([lat, lon]).addTo(map);
                setTimeout(() => { map.invalidateSize(); }, 300);
            }

            // --- LE FINAL CRASH ---
            setTimeout(async () => {
                document.getElementById('hacker-screen').style.display = 'none';
                document.getElementById('iphone-dead').style.display = 'block';

                const debugLines = ["[ 0.00] boot_init", "[ 0.12] kernel_panic", "[ 0.45] fsociety_detected", "[ 1.10] system_halt"];
                let debugDiv = document.getElementById('debug-text');
                for (let l of debugLines) {
                    let d = document.createElement('div');
                    d.innerText = l; d.style.fontSize = "10px";
                    debugDiv.appendChild(d);
                    await new Promise(r => setTimeout(r, 200));
                }

                await new Promise(r => setTimeout(r, 1000));
                debugDiv.style.display = 'none';
                document.getElementById('apple-logo').style.display = 'block';
                
                if (navigator.vibrate) navigator.vibrate([500, 100, 500]);
            }, 8000);
        }
    </script>
</body>
</html>